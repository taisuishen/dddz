<template>
  <div class="min-h-screen bg-gradient-to-br from-green-900 via-green-800 to-green-700 overflow-hidden">
    <!-- È°∂ÈÉ®‰ø°ÊÅØÊ†è -->
    <header class="bg-green-900/50 backdrop-blur-md border-b border-green-700 px-4 py-2">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <button
            @click="leaveGame"
            class="text-gray-300 hover:text-white transition-colors"
          >
            <ArrowLeft class="w-5 h-5" />
          </button>
          <div class="text-white">
            <span class="font-bold">{{ roomStore.currentRoom?.name }}</span>
            <span class="text-gray-300 ml-2">Áõ≤Ê≥®: {{ roomStore.currentRoom?.smallBlind }}/{{ roomStore.currentRoom?.bigBlind }}</span>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-yellow-500 font-bold">
            Â∫ïÊ±†: {{ gameStore.currentGame?.pot.toLocaleString() || 0 }}
          </div>
          <div class="text-white">
            {{ userStore.user?.username }}
          </div>
        </div>
      </div>
    </header>

    <div class="h-[calc(100vh-60px)]">
      <!-- ‰∏ªÊ∏∏ÊàèÂå∫Âüü -->
      <div class="w-full h-full relative">
        <!-- ÁâåÊ°å -->
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="relative">
            <!-- Ê§≠ÂúÜÂΩ¢ÁâåÊ°å -->
            <div class="w-[300px] h-[200px] md:w-[600px] md:h-[400px] bg-green-800 rounded-full border-4 md:border-8 border-yellow-600 shadow-2xl relative">
              <!-- ÂÖ¨ÂÖ±ÁâåÂå∫Âüü -->
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                <!-- ÊâÄÊúâÂÖ¨ÂÖ±ÁâåÊòæÁ§∫Âú®‰∏ÄË°å -->
                <div class="flex space-x-2 mb-3 justify-center">
                  <!-- Â∑≤ÂèëÁöÑÂÖ¨ÂÖ±Áâå -->
                  <div
                    v-for="(card, index) in communityCards"
                    :key="'community-' + index"
                    :class="getCardColor(card.suit)"
                    class="w-12 h-16 rounded-lg border-2 flex flex-col items-center justify-center text-xs font-bold shadow-lg transform hover:scale-105 transition-transform bg-white"
                  >
                    <div class="text-center leading-tight">
                      <div>{{ getDisplayRank(card.rank) }}</div>
                      <div class="text-lg">{{ getSuitSymbol(card.suit) }}</div>
                    </div>
                  </div>
                  
                  <!-- Êú™ÂèëÁâåÁöÑÂç†‰ΩçÁ¨¶ -->
                  <div 
                    v-for="i in Math.max(0, 5 - communityCards.length)" 
                    :key="'placeholder-' + i" 
                    class="w-12 h-16 bg-green-700/50 border-2 border-dashed border-green-500/50 rounded-lg flex items-center justify-center"
                  >
                    <span class="text-green-400 text-xs">?</span>
                  </div>
                </div>
                
                <!-- Â∫ïÊ±†ÊòæÁ§∫ -->
                <div class="text-center mt-4">
                  <div class="bg-yellow-500 text-green-900 px-4 py-2 rounded-full font-bold text-lg shadow-lg">
                    Â∫ïÊ±†: {{ gameStore.currentGame?.pot.toLocaleString() || 0 }}
                  </div>
                </div>
              </div>

              <!-- Áé©ÂÆ∂‰ΩçÁΩÆ -->
              <div
                v-for="index in maxSeats"
                :key="index"
                :class="getPlayerPositionClass(index - 1, maxSeats)"
                :style="getPlayerPositionStyle(index - 1, maxSeats)"
                class="absolute"
              >
                <PlayerSeat
                  :player="getPlayerAtSeat(index - 1)"
                  :seat-index="index - 1"
                  :is-current="isCurrentPlayerAtSeat(index - 1)"
                  :is-dealer="isDealerAtSeat(index - 1)"
                  @seat-click="handleSeatClick"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Ê∏∏ÊàèÈò∂ÊÆµÊåáÁ§∫Âô® -->
        <div class="absolute top-4 left-4">
          <div class="bg-white/10 backdrop-blur-md rounded-lg px-4 py-2 border border-white/20">
            <div class="text-white font-bold">
              {{ getPhaseText(gameStore.currentGame?.phase) }}
            </div>
          </div>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆÂå∫Âüü -->
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-full max-w-4xl px-4">
          <!-- Ê∏∏ÊàèÊú™ÂºÄÂßãÊó∂ÊòæÁ§∫ÂáÜÂ§áÊåâÈíÆ -->
          <div v-if="gameStore.currentGame?.phase === 'waiting'" class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 justify-center">
            <!-- Âè™ÊúâÂΩìÁî®Êà∑Âú®Ê∏∏Êàè‰∏≠Êó∂ÊâçÊòæÁ§∫ÂáÜÂ§áÊåâÈíÆ - Á°Æ‰øùIDÁ±ªÂûãÂåπÈÖç -->
            <template v-if="gameStore.currentGame.players.find(p => p.id === String(userStore.user?.id))">
              <button
                v-if="!isPlayerReady"
                @click="toggleReady"
                class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg"
              >
                ÂáÜÂ§á
              </button>
              <button
                v-else
                @click="toggleReady"
                class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg"
              >
                ÂèñÊ∂àÂáÜÂ§á
              </button>
            </template>

          </div>
          
          <!-- Ê∏∏ÊàèËøõË°å‰∏≠ÁöÑÊìç‰ΩúÊåâÈíÆ -->
          <div v-else-if="isMyTurn" class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 justify-center">
            <!-- ÂºÉÁâå -->
            <button
              @click="fold"
              class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg"
            >
              ÂºÉÁâå
            </button>
            
            <!-- Ë∑üÊ≥®/ËøáÁâå -->
            <button
              @click="callOrCheck"
              :class="[
                'font-bold py-3 px-6 rounded-xl transition-all shadow-lg',
                needToCall ? 'bg-yellow-600 hover:bg-yellow-500 text-white' : 'bg-green-600 hover:bg-green-500 text-white'
              ]"
            >
              {{ needToCall ? `Ë∑üÊ≥® ${callAmount}` : 'ËøáÁâå' }}
            </button>
            
            <!-- Âä†Ê≥® -->
            <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-2">
              <button
                @click="raise"
                :disabled="raiseAmount < minRaise"
                class="bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-auto"
              >
                Âä†Ê≥®
              </button>
              <input
                v-model.number="raiseAmount"
                type="number"
                :min="minRaise"
                :step="minRaise"
                :max="currentPlayerChips"
                class="w-full md:w-24 px-2 py-1 bg-white/20 border border-white/30 rounded text-white text-center focus:outline-none focus:ring-2 focus:ring-yellow-500"
                :placeholder="`Âä†Ê≥®: ${minRaise}ÁöÑÂÄçÊï∞`"
              />
            </div>
            
            <!-- ÂÖ®‰∏ã -->
            <button
              @click="allIn"
              class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg"
            >
              ÂÖ®‰∏ã
            </button>
            
            <!-- Â±ïÁ§∫ÊâãÁâå -->
            <button
              @click="showCards"
              class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg"
            >
              Â±ïÁ§∫ÊâãÁâå
            </button>
          </div>
          
          <!-- Ê∏∏ÊàèÁªìÊùüÁä∂ÊÄÅ -->
          <div v-else-if="gameStore.currentGame?.phase === 'finished' && showGameEndStatus" class="text-white text-center space-y-4">
            <div class="bg-gradient-to-r from-yellow-600/20 to-orange-600/20 backdrop-blur-md rounded-xl px-8 py-6 border border-yellow-500/30">
              <h2 class="text-2xl font-bold text-yellow-400 mb-4">üéâ Ê∏∏ÊàèÁªìÊùü üéâ</h2>
              
              <!-- ÊòæÁ§∫Ëé∑ËÉúËÄÖ‰ø°ÊÅØ -->
              <div v-if="gameStore.gameResults && gameStore.gameResults.results && gameStore.gameResults.results.length > 0" class="mb-4">
                <h3 class="text-lg font-semibold text-white mb-2">Ëé∑ËÉúËÄÖ:</h3>
                <div class="space-y-2">
                  <div 
                    v-for="result in gameStore.gameResults.results.filter(r => r.win_amount > 0)" 
                    :key="result.user_id"
                    class="bg-white/10 rounded-lg px-4 py-2"
                  >
                    <span class="text-yellow-300 font-bold">{{ result.username }}</span>
                    <span class="text-white ml-2">Ëµ¢Âæó {{ result.win_amount.toLocaleString() }} Á≠πÁ†Å</span>
                  </div>
                </div>
              </div>
              
              <!-- ÊòæÁ§∫Â∫ïÊ±†‰ø°ÊÅØ -->
              <div class="text-gray-300 mb-4">
                ÊÄªÂ∫ïÊ±†: {{ gameStore.currentGame?.pot?.toLocaleString() || 0 }} Á≠πÁ†Å
              </div>
              
              <!-- Êìç‰ΩúÊåâÈíÆ -->
              <div class="flex justify-center">
                <button
                  @click="leaveGame"
                  class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg"
                >
                  ËøîÂõûÂ§ßÂéÖ
                </button>
              </div>
            </div>
          </div>
          
          <!-- Á≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂ -->
          <div v-else class="text-white text-center">
            <div class="bg-white/10 backdrop-blur-md rounded-lg px-6 py-3 border border-white/20">
              {{ (gameStore.currentGame?.phase as string) === 'waiting' ? 'Á≠âÂæÖÊâÄÊúâÁé©ÂÆ∂ÂáÜÂ§á...' : 'Á≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂Êìç‰Ωú...' }}
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Ê∏∏ÊàèÁªìÊûúËØ¶ÊÉÖÂºπÁ™ó -->
    <div v-if="showGameResultModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-white text-2xl font-bold">üÉè Ê∏∏ÊàèÁªìÊûúËØ¶ÊÉÖ</h3>
          <button
            @click="showGameResultModal = false"
            class="text-white hover:text-gray-300 text-2xl font-bold"
          >
            √ó
          </button>
        </div>
        
        <!-- ÂÖ¨ÂÖ±ÁâåÂ±ïÁ§∫ -->
        <div class="mb-8">
          <h4 class="text-white text-lg font-semibold mb-4 text-center">ÂÖ¨ÂÖ±Áâå</h4>
          <div class="flex justify-center space-x-3">
            <div
              v-for="(card, index) in communityCards" 
              :key="`community-${index}`"
              :class="getCardColor(card.suit)"
              class="w-16 h-24 rounded-lg border-2 flex flex-col items-center justify-center text-sm font-bold shadow-lg bg-white"
            >
              <div class="text-center leading-tight">
                <div class="text-lg">{{ getDisplayRank(card.rank) }}</div>
                <div class="text-xl">{{ getSuitSymbol(card.suit) }}</div>
              </div>
            </div>
            <!-- Â¶ÇÊûúÂÖ¨ÂÖ±Áâå‰∏çË∂≥5Âº†ÔºåÊòæÁ§∫Á©∫ÁôΩÂç†‰ΩçÁ¨¶ -->
            <div
              v-for="index in (5 - communityCards.length)" 
              :key="`placeholder-${index}`"
              class="w-16 h-24 rounded-lg border-2 border-dashed border-white/30 flex items-center justify-center bg-white/10"
            >
              <span class="text-white/50 text-xs">?</span>
            </div>
          </div>
        </div>
        
        <!-- Áé©ÂÆ∂ÊâãÁâåÊéíÂ∫è -->
        <div class="space-y-4">
          <h4 class="text-white text-lg font-semibold mb-4">Áé©ÂÆ∂ÊâãÁâåÊéíÂ∫è (ÊåâÁâåÂäõ‰ªéÂ§ßÂà∞Â∞è)</h4>
          
          <div 
            v-for="(playerResult, index) in sortedPlayerResults" 
            :key="playerResult.playerId"
            class="bg-white/10 rounded-xl p-4 border border-white/20"
          >
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <!-- Áé©ÂÆ∂‰ø°ÊÅØÂíåÊéíÂêç -->
              <div class="flex items-center space-x-4">
                <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold w-8 h-8 rounded-full flex items-center justify-center text-sm">
                  {{ index + 1 }}
                </div>
                <div>
                  <div class="text-white font-bold text-lg">{{ playerResult.username }}</div>
                  <div class="text-gray-300 text-sm">{{ playerResult.handType }}</div>
                </div>
              </div>
              
              <!-- ÊâãÁâåÂ±ïÁ§∫ -->
              <div class="flex space-x-2">
                <div
                  v-for="card in playerResult.cards" 
                  :key="`${card.suit}-${card.rank}`"
                  :class="getCardColor(card.suit)"
                  class="w-12 h-16 rounded-lg border-2 flex flex-col items-center justify-center text-xs font-bold shadow-lg transform hover:scale-105 transition-transform bg-white"
                >
                  <div class="text-center leading-tight">
                    <div>{{ getDisplayRank(card.rank) }}</div>
                    <div class="text-lg">{{ getSuitSymbol(card.suit) }}</div>
                  </div>
                </div>
              </div>
              
              <!-- ËæìËµ¢ÈáëÈ¢ù -->
              <div class="text-right">
                <div :class="playerResult.winAmount >= 0 ? 'text-green-400' : 'text-red-400'" class="font-bold text-lg">
                  {{ playerResult.winAmount >= 0 ? '+' : '' }}{{ playerResult.winAmount.toLocaleString() }}
                </div>
                <div class="text-gray-300 text-sm">Á≠πÁ†ÅÂèòÂåñ</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="flex justify-center mt-6">
          <button
            @click="leaveGame"
            class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg"
          >
            ËøîÂõûÂ§ßÂéÖ
          </button>
        </div>
      </div>
    </div>


  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted, watch } from 'vue'
import { useRouter } from 'vue-router'
import { ArrowLeft } from 'lucide-vue-next'
import { useUserStore } from '../stores/user'
import { useRoomStore } from '../stores/room'
import { useGameStore, type Card, type Player, type GameState } from '../stores/game'
import PlayerSeat from '../components/PlayerSeat.vue'
import PlayingCard from '../components/PlayingCard.vue'
import { websocketService, connectWebSocket, disconnectWebSocket } from '../utils/websocket'

// APIÂü∫Á°ÄURL
const API_BASE_URL = 'http://localhost:8000'

const router = useRouter()
const userStore = useUserStore()
const roomStore = useRoomStore()
const gameStore = useGameStore()

const raiseAmount = ref(100)

const isPlayerReady = ref(false)
const showGameResultModal = ref(false)
const showGameEndStatus = ref(false)

// ÁõëÂê¨Ê∏∏ÊàèÈò∂ÊÆµÂèòÂåñÔºåËá™Âä®ÊòæÁ§∫ÁªìÊûúÂºπÁ™ó
watch(() => gameStore.currentGame?.phase, (newPhase, oldPhase) => {
  // Âè™ÊúâÂú®Ê∏∏ÊàèËøõË°å‰∏≠ÂàáÊç¢Âà∞finishedÁä∂ÊÄÅÊó∂ÊâçÊòæÁ§∫ÂºπÁ™ó
  // ÈÅøÂÖçÂàùÊ¨°ËøõÂÖ•Ê∏∏ÊàèÊó∂ÊòæÁ§∫‰∏ä‰∏ÄÂ±ÄÁöÑÁªìÊûú
  if (newPhase === 'finished' && oldPhase && oldPhase !== 'finished') {
    // ÊòæÁ§∫Â∫ïÈÉ®Ê∏∏ÊàèÁªìÊùüÁä∂ÊÄÅ
    showGameEndStatus.value = true
    // 3ÁßíÂêéËá™Âä®ÈöêËóèÂ∫ïÈÉ®Ê∏∏ÊàèÁªìÊùüÁä∂ÊÄÅ
    setTimeout(() => {
      showGameEndStatus.value = false
    }, 3000)
    
    // Âè™ÊúâÂΩìÂâçÁî®Êà∑ÂèÇ‰∏é‰∫ÜÊ∏∏ÊàèÊâçÊòæÁ§∫ÂºπÁ™ó
    const currentUserId = String(userStore.user?.id)
    const currentPlayer = gameStore.currentGame?.players.find(p => p.id === currentUserId)
    if (currentPlayer && currentPlayer.cards && currentPlayer.cards.length > 0) {
      showGameResultModal.value = true
    }
  }
  
  // ÂΩìÊ∏∏ÊàèÂºÄÂßãÊñ∞‰∏ÄËΩÆÊó∂ÔºåÊ∏ÖÈô§‰πãÂâçÁöÑÊ∏∏ÊàèÁªìÊûúÊï∞ÊçÆ
  if (newPhase === 'preflop' && oldPhase === 'finished') {
    gameStore.clearGameResults()
    showGameResultModal.value = false
    showGameEndStatus.value = false
  }
  
  // ÂΩìËøõÂÖ•Á≠âÂæÖÁä∂ÊÄÅÊó∂Ôºå‰∏çËá™Âä®ÂÖ≥Èó≠ÁªìÊûúÂºπÁ™óÔºåËÆ©Áî®Êà∑ÊâãÂä®ÂÖ≥Èó≠
  // ÁßªÈô§Ëá™Âä®ÂÖ≥Èó≠ÈÄªËæëÔºå‰øùÊåÅÂºπÁ™óÊòæÁ§∫Áõ¥Âà∞Áî®Êà∑ÊâãÂä®ÂÖ≥Èó≠
})



// ÂÖ¨ÂÖ±Áâå
const communityCards = computed(() => gameStore.currentGame?.communityCards || [])

// ËÆ°ÁÆóÂ±ûÊÄß
const players = computed(() => gameStore.currentGame?.players || [])
// ‰ºòÂåñÁöÑÈò≤ÊäñÈÄªËæëÔºöÊõ¥Á®≥ÂÆöÁöÑÁä∂ÊÄÅÁÆ°ÁêÜ
const stableGameState = ref<any>(null)
const lastStateUpdateTime = ref(0)
const stateUpdateCount = ref(0)
const STATE_UPDATE_DEBOUNCE = 500 // Â¢ûÂä†Âà∞500msÈò≤Êäñ
const MAX_UPDATES_PER_SECOND = 3 // ÊØèÁßíÊúÄÂ§ö3Ê¨°Êõ¥Êñ∞

const isMyTurn = computed(() => {
  const now = Date.now()
  const currentUserId = userStore.user?.id?.toString()
  
  console.log(`\n=== isMyTurn ËÆ°ÁÆóÂºÄÂßã [${new Date().toLocaleTimeString()}] ===`)
  console.log('ÂΩìÂâçÊó∂Èó¥Êà≥:', now)
  console.log('Áî®Êà∑ID:', currentUserId)
  
  // Âü∫Á°ÄÊ£ÄÊü•
  if (!gameStore.currentGame || !currentUserId) {
    console.log('‚ùå Âü∫Á°ÄÊ£ÄÊü•Â§±Ë¥•: Ê∏∏ÊàèÁä∂ÊÄÅÊàñÁî®Êà∑ID‰∏∫Á©∫')
    return false
  }
  
  const game = gameStore.currentGame
  console.log('Ê∏∏ÊàèÂü∫Á°Ä‰ø°ÊÅØ:')
  console.log('  Ê∏∏ÊàèÈò∂ÊÆµ:', game.phase)
  console.log('  ÂΩìÂâçÁé©ÂÆ∂ID:', game.currentPlayerId)
  console.log('  Áé©ÂÆ∂ÊÄªÊï∞:', game.players.length)
  
  // Ê∏∏ÊàèÈò∂ÊÆµÊ£ÄÊü•
  if (game.phase === 'waiting' || game.phase === 'finished') {
    console.log('‚ùå Ê∏∏ÊàèÈò∂ÊÆµÊ£ÄÊü•Â§±Ë¥•: Ê∏∏ÊàèÂ§Ñ‰∫éÁ≠âÂæÖÊàñÁªìÊùüÁä∂ÊÄÅ')
    return false
  }
  
  // Â¢ûÂº∫ÁöÑÈò≤ÊäñÈÄªËæë
  const timeSinceLastUpdate = now - lastStateUpdateTime.value
  
  // ÈáçÁΩÆÊõ¥Êñ∞ËÆ°Êï∞Âô®ÔºàÊØèÁßíÈáçÁΩÆÔºâ
  if (timeSinceLastUpdate > 1000) {
    stateUpdateCount.value = 0
  }
  
  console.log('Èò≤ÊäñÊ£ÄÊü•:')
  console.log('  Ë∑ùÁ¶ª‰∏äÊ¨°Êõ¥Êñ∞:', timeSinceLastUpdate, 'ms')
  console.log('  Êú¨ÁßíÊõ¥Êñ∞Ê¨°Êï∞:', stateUpdateCount.value)
  console.log('  Èò≤ÊäñÈòàÂÄº:', STATE_UPDATE_DEBOUNCE, 'ms')
  
  // Â¶ÇÊûúÊõ¥Êñ∞Ëøá‰∫éÈ¢ëÁπÅÔºå‰ΩøÁî®Á®≥ÂÆöÁä∂ÊÄÅ
  const shouldUseStableState = (
    (timeSinceLastUpdate < STATE_UPDATE_DEBOUNCE && stableGameState.value) ||
    (stateUpdateCount.value >= MAX_UPDATES_PER_SECOND && stableGameState.value)
  )
  
  if (shouldUseStableState) {
    console.log('‚è±Ô∏è Èò≤ÊäñËß¶Âèë: ‰ΩøÁî®Á®≥ÂÆöÁä∂ÊÄÅ')
    console.log('Á®≥ÂÆöÁä∂ÊÄÅÂΩìÂâçÁé©ÂÆ∂ID:', stableGameState.value.currentPlayerId)
    
    const stableResult = stableGameState.value.currentPlayerId === currentUserId
    console.log('Á®≥ÂÆöÁä∂ÊÄÅÂåπÈÖçÁªìÊûú:', stableResult)
    console.log('=== isMyTurn ËÆ°ÁÆóÁªìÊùü (‰ΩøÁî®Á®≥ÂÆöÁä∂ÊÄÅ) ===\n')
    return stableResult
  }
  
  console.log('üîÑ Áä∂ÊÄÅÊõ¥Êñ∞: ‰ΩøÁî®ÊúÄÊñ∞Áä∂ÊÄÅ')
  
  // Ê£ÄÊü•Áä∂ÊÄÅÊòØÂê¶ÁúüÁöÑÂèëÁîü‰∫ÜÂèòÂåñ
  const hasStateChanged = !stableGameState.value || 
    stableGameState.value.currentPlayerId !== game.currentPlayerId ||
    stableGameState.value.phase !== game.phase
  
  if (hasStateChanged) {
    console.log('Áä∂ÊÄÅÁ°ÆÂÆûÂèëÁîüÂèòÂåñÔºåÊõ¥Êñ∞Á®≥ÂÆöÁä∂ÊÄÅ')
    stableGameState.value = {
      currentPlayerId: game.currentPlayerId,
      phase: game.phase,
      currentPlayerIndex: game.currentPlayerIndex
    }
    lastStateUpdateTime.value = now
    stateUpdateCount.value++
  } else {
    console.log('Áä∂ÊÄÅÊú™ÂèëÁîüÂèòÂåñÔºå‰øùÊåÅÁ®≥ÂÆöÁä∂ÊÄÅ')
  }
  
  // Áé©ÂÆ∂ÂåπÈÖçÊ£ÄÊü•
  console.log('Áé©ÂÆ∂ÂåπÈÖçÊ£ÄÊü•:')
  console.log('  ÂΩìÂâçË°åÂä®Áé©ÂÆ∂ID:', game.currentPlayerId)
  console.log('  ÁôªÂΩïÁî®Êà∑ID:', currentUserId)
  
  const isMatch = game.currentPlayerId === currentUserId
  console.log('ÊúÄÁªàÂåπÈÖçÁªìÊûú:', isMatch)
  
  if (isMatch) {
    console.log('‚úÖ Áé©ÂÆ∂ÂåπÈÖçÊàêÂäü: ÊòæÁ§∫Êìç‰ΩúÊåâÈíÆ')
  } else {
    console.log('‚ùå Áé©ÂÆ∂ÂåπÈÖçÂ§±Ë¥•: ÈöêËóèÊìç‰ΩúÊåâÈíÆ')
  }
  
  console.log('=== isMyTurn ËÆ°ÁÆóÁªìÊùü ===\n')
  return isMatch
})

const currentPlayerChips = computed(() => {
  if (!userStore.user || !gameStore.currentGame) return 0
  const player = gameStore.currentGame.players.find(p => p.id === String(userStore.user.id))
  return player?.chips || 0
})

const needToCall = computed(() => {
  if (!gameStore.currentGame || !userStore.user) return false
  const player = gameStore.currentGame.players.find(p => p.id === String(userStore.user.id))
  return (player?.currentBet || 0) < gameStore.currentGame.currentBet
})

const callAmount = computed(() => {
  if (!gameStore.currentGame || !userStore.user) return 0
  const player = gameStore.currentGame.players.find(p => p.id === String(userStore.user.id))
  return gameStore.currentGame.currentBet - (player?.currentBet || 0)
})

const minRaise = computed(() => {
  if (!gameStore.currentGame) return 0
  
  // Ëé∑Âèñ‰∏ä‰∏Ä‰∏™Âä†Ê≥®ÁöÑÈáëÈ¢ù
  const currentBet = gameStore.currentGame.currentBet || 0
  const bigBlind = gameStore.currentGame.bigBlind || 20
  
  // Â¶ÇÊûúÂΩìÂâçÊ≤°Êúâ‰∫∫‰∏ãÊ≥®ÔºåÊúÄÂ∞èÂä†Ê≥®ÊòØÂ§ßÁõ≤Ê≥®
  if (currentBet === 0) {
    return bigBlind
  }
  
  // ÊúÄÂ∞èÂä†Ê≥®ÊòØ‰∏ä‰∏Ä‰∏™Âä†Ê≥®ÁöÑÈáëÈ¢ùÔºàÂç≥ÂΩìÂâçÊúÄÈ´ò‰∏ãÊ≥®ÂáèÂéªÂ§ßÁõ≤Ê≥®Ôºâ
  const lastRaiseAmount = Math.max(currentBet - bigBlind, bigBlind)
  return lastRaiseAmount
})

// Ê†πÊçÆÊàøÈó¥ÊúÄÂ§ßÁé©ÂÆ∂Êï∞Á°ÆÂÆöÂ∫ß‰ΩçÊï∞Èáè
const maxSeats = computed(() => {
  return roomStore.currentRoom?.max_players || roomStore.currentRoom?.maxPlayers || 9
})



// Ê∏∏ÊàèÁªìÊûúÊéíÂ∫èËÆ°ÁÆóÂ±ûÊÄß
const sortedPlayerResults = computed(() => {
  // ‰ºòÂÖà‰ΩøÁî®gameStore‰∏≠ÁöÑÊ∏∏ÊàèÁªìÊûúÊï∞ÊçÆ
  if (gameStore.gameResults && gameStore.gameResults.results) {
    return gameStore.gameResults.results.map(result => ({
      playerId: result.user_id,
      username: result.username,
      cards: result.hole_cards,
      handType: result.hand_rank,
      handStrength: result.hand_strength,
      winAmount: result.win_amount
    }))
  }
  
  // Â¶ÇÊûúÊ≤°ÊúâÊ∏∏ÊàèÁªìÊûúÊï∞ÊçÆÔºå‰ΩøÁî®ÂéüÊúâÈÄªËæë‰Ωú‰∏∫ÂêéÂ§á
  if (!gameStore.currentGame || gameStore.currentGame.phase !== 'finished') return []
  
  // Ëé∑ÂèñÊâÄÊúâÊú™ÂºÉÁâåÁöÑÁé©ÂÆ∂
  const activePlayers = gameStore.currentGame.players.filter(player => 
    !player.isFolded && player.cards && player.cards.length > 0
  )
  
  // ËÆ°ÁÆóÊØè‰∏™Áé©ÂÆ∂ÁöÑÁªìÊûú
  const playerResults = activePlayers.map(player => {
    // ËÆ°ÁÆóÊâãÁâåÁ±ªÂûãÂíåÂº∫Â∫¶
    const handInfo = evaluateHand(player.cards, gameStore.currentGame?.communityCards || [])
    
    // ËÆ°ÁÆóËæìËµ¢ÈáëÈ¢ù - ‰ΩøÁî®gameResultsÊï∞ÊçÆ
    let winAmount = 0
    if (gameStore.gameResults && gameStore.gameResults.results) {
      const result = gameStore.gameResults.results.find(r => r.user_id === player.id)
      if (result) {
        winAmount = result.win_amount
      }
    }
    
    // Â¶ÇÊûúÊ≤°ÊúâÊ∏∏ÊàèÁªìÊûúÊï∞ÊçÆÔºåËÆ°ÁÆóÊçüÂ§±ÔºàÂΩìÂâç‰∏ãÊ≥®ÈáëÈ¢ùÔºâ
    if (winAmount === 0) {
      winAmount = -(player.currentBet || 0)
    }
    
    return {
      playerId: player.id,
      username: player.username,
      cards: player.cards,
      handType: handInfo.type,
      handStrength: handInfo.strength,
      winAmount: winAmount
    }
  })
  
  // ÊåâÊâãÁâåÂº∫Â∫¶‰ªéÂ§ßÂà∞Â∞èÊéíÂ∫è
  return playerResults.sort((a, b) => b.handStrength - a.handStrength)
})

// ÊâãÁâåËØÑ‰º∞ÂáΩÊï∞
const evaluateHand = (playerCards: Card[], communityCards: Card[]) => {
  // ÂêàÂπ∂Áé©ÂÆ∂ÊâãÁâåÂíåÂÖ¨ÂÖ±Áâå
  const allCards = [...playerCards, ...communityCards]
  
  // ÁÆÄÂåñÁöÑÊâãÁâåËØÑ‰º∞ÈÄªËæë
  // ËøôÈáåÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÂÆûÁé∞Êõ¥Â§çÊùÇÁöÑÂæ∑Â∑ûÊâëÂÖãÊâãÁâåËØÑ‰º∞
  
  // ÊåâÁÇπÊï∞ÂàÜÁªÑ
  const rankCounts: { [key: number]: number } = {}
  allCards.forEach(card => {
    rankCounts[card.rank] = (rankCounts[card.rank] || 0) + 1
  })
  
  // ÊåâËä±Ëâ≤ÂàÜÁªÑ
  const suitCounts: { [key: string]: number } = {}
  allCards.forEach(card => {
    suitCounts[card.suit] = (suitCounts[card.suit] || 0) + 1
  })
  
  const counts = Object.values(rankCounts).sort((a, b) => b - a)
  const maxSuitCount = Math.max(...Object.values(suitCounts))
  
  // Âà§Êñ≠ÊâãÁâåÁ±ªÂûãÂíåÂº∫Â∫¶
  if (counts[0] === 4) {
    return { type: 'ÂõõÊù°', strength: 7000 + Math.max(...Object.keys(rankCounts).map(Number)) }
  } else if (counts[0] === 3 && counts[1] === 2) {
    return { type: 'Ëë´Ëä¶', strength: 6000 + Math.max(...Object.keys(rankCounts).map(Number)) }
  } else if (maxSuitCount >= 5) {
    return { type: 'ÂêåËä±', strength: 5000 + Math.max(...allCards.map(c => c.rank)) }
  } else if (counts[0] === 3) {
    return { type: '‰∏âÊù°', strength: 3000 + Math.max(...Object.keys(rankCounts).map(Number)) }
  } else if (counts[0] === 2 && counts[1] === 2) {
    return { type: '‰∏§ÂØπ', strength: 2000 + Math.max(...Object.keys(rankCounts).map(Number)) }
  } else if (counts[0] === 2) {
    return { type: '‰∏ÄÂØπ', strength: 1000 + Math.max(...Object.keys(rankCounts).map(Number)) }
  } else {
    return { type: 'È´òÁâå', strength: Math.max(...allCards.map(c => c.rank)) }
  }
}

// ÊñπÊ≥ï
const getCardColor = (suit: string) => {
  // ÊîØÊåÅÂêéÁ´ØËøîÂõûÁöÑÁ¨¶Âè∑Ê†ºÂºèÂíåËã±ÊñáÂêçÁß∞Ê†ºÂºè
  if (suit === '‚ô•' || suit === '‚ô¶' || suit === 'hearts' || suit === 'diamonds') {
    return 'text-red-600'
  }
  return 'text-black'
}

const getSuitSymbol = (suit: string) => {
  // Â¶ÇÊûúÂ∑≤ÁªèÊòØÁ¨¶Âè∑ÔºåÁõ¥Êé•ËøîÂõû
  if (['‚ô•', '‚ô¶', '‚ô£', '‚ô†'].includes(suit)) {
    return suit
  }
  
  // Â¶ÇÊûúÊòØËã±ÊñáÂêçÁß∞ÔºåËΩ¨Êç¢‰∏∫Á¨¶Âè∑
  const symbols = {
    hearts: '‚ô•',
    diamonds: '‚ô¶',
    clubs: '‚ô£',
    spades: '‚ô†'
  }
  return symbols[suit as keyof typeof symbols] || suit
}

const getDisplayRank = (rank: number) => {
  if (rank === 1) return 'A'
  if (rank === 11) return 'J'
  if (rank === 12) return 'Q'
  if (rank === 13) return 'K'
  if (rank === 14) return 'A'
  return rank.toString()
}

const getPlayerPositionClass = (index: number, totalSeats: number) => {
  // ÂØπ‰∫é6Â∫ß‰ΩçÂèä‰ª•‰∏ãÔºå‰ΩøÁî®È¢ÑËÆæÁöÑTailwindÁ±ª
  if (totalSeats <= 6) {
    const positions = [
      'bottom-2 left-1/2 transform -translate-x-1/2 translate-y-full',
      'bottom-8 right-2 transform translate-x-full',
      'top-8 right-2 transform translate-x-full', 
      'top-2 left-1/2 transform -translate-x-1/2 -translate-y-full',
      'top-8 left-2 transform -translate-x-full',
      'bottom-8 left-2 transform -translate-x-full'
    ]
    return positions[index] || positions[0]
  }
  // ÂØπ‰∫éÊõ¥Â§öÂ∫ß‰ΩçÔºåÂè™ËøîÂõûÂü∫Êú¨ÁöÑtransformÁ±ª
  return 'transform -translate-x-1/2 -translate-y-1/2'
}

const getPlayerPositionStyle = (index: number, totalSeats: number) => {
  // ÂØπ‰∫é6Â∫ß‰ΩçÂèä‰ª•‰∏ãÔºå‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÊ†∑Âºè
  if (totalSeats <= 6) {
    return {}
  }
  
  // ÂØπ‰∫éÊõ¥Â§öÂ∫ß‰ΩçÔºå‰ΩøÁî®Âä®ÊÄÅËÆ°ÁÆóÁöÑ‰ΩçÁΩÆ
  const angle = (index * 360) / totalSeats
  const radians = (angle * Math.PI) / 180
  
  // Ê§≠ÂúÜÂèÇÊï∞ÔºàÁõ∏ÂØπ‰∫éÂÆπÂô®ÁöÑÁôæÂàÜÊØîÔºâ
  const a = 45 // Ê∞¥Âπ≥ÂçäÂæÑÁôæÂàÜÊØî
  const b = 35 // ÂûÇÁõ¥ÂçäÂæÑÁôæÂàÜÊØî
  
  // ËÆ°ÁÆó‰ΩçÁΩÆÔºà‰ªéÈ°∂ÈÉ®ÂºÄÂßãÔºåÈ°∫Êó∂ÈíàÔºâ
  const x = 50 + a * Math.cos(radians - Math.PI / 2)
  const y = 50 + b * Math.sin(radians - Math.PI / 2)
  
  return {
    left: `${x}%`,
    top: `${y}%`
  }
}

const getPhaseText = (phase?: string) => {
  const phaseTexts = {
    waiting: 'Á≠âÂæÖÂºÄÂßã',
    preflop: 'ÁøªÁâåÂâç',
    flop: 'ÁøªÁâå',
    turn: 'ËΩ¨Áâå',
    river: 'Ê≤≥Áâå',
    showdown: 'ÊëäÁâå',
    finished: 'ÁªìÊùü'
  }
  return phaseTexts[phase as keyof typeof phaseTexts] || 'Êú™Áü•Èò∂ÊÆµ'
}

const formatTime = (timestamp: Date) => {
  return timestamp.toLocaleTimeString('zh-CN', { 
    hour: '2-digit', 
    minute: '2-digit' 
  })
}

// Ê∏∏ÊàèÊìç‰Ωú
const fold = () => {
  if (!userStore.user || !roomStore.currentRoom) return
  
  console.log('Áé©ÂÆ∂ÂºÉÁâå')
  websocketService.sendGameAction(Number(roomStore.currentRoom.id), 'fold')
}

const callOrCheck = () => {
  if (!userStore.user || !gameStore.currentGame || !roomStore.currentRoom) return
  
  const action = needToCall.value ? 'call' : 'check'
  const amount = needToCall.value ? callAmount.value : 0
  
  console.log(`Áé©ÂÆ∂${action}:`, amount)
  websocketService.sendGameAction(Number(roomStore.currentRoom.id), action, amount)
}

const raise = () => {
  if (!userStore.user || !gameStore.currentGame || !roomStore.currentRoom) return
  
  const currentUserId = String(userStore.user.id)
  const player = gameStore.currentGame.players.find(p => p.id === currentUserId)
  if (!player) return
  
  // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúÄÂ∞èÂä†Ê≥®ÁöÑÂÄçÊï∞
  if (raiseAmount.value % minRaise.value !== 0) {
    alert(`Âä†Ê≥®ÈáëÈ¢ùÂøÖÈ°ªÊòØ ${minRaise.value} ÁöÑÂÄçÊï∞`)
    return
  }
  
  // ËÆ°ÁÆóÊÄª‰∏ãÊ≥®ÈáëÈ¢ùÔºàÂΩìÂâç‰∏ãÊ≥® + Âä†Ê≥®ÈáëÈ¢ùÔºâ
  const totalBet = (player.currentBet || 0) + raiseAmount.value
  
  // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøáÁé©ÂÆ∂Á≠πÁ†Å
  if (totalBet > player.chips) {
    alert('Á≠πÁ†Å‰∏çË∂≥ÔºåËØ∑ÈÄâÊã©ÂÖ®‰∏ã')
    return
  }
  
  console.log('Áé©ÂÆ∂Âä†Ê≥®:', raiseAmount.value, 'ÊÄª‰∏ãÊ≥®:', totalBet)
  websocketService.sendGameAction(Number(roomStore.currentRoom.id), 'raise', totalBet)
}

const allIn = () => {
  if (!userStore.user || !gameStore.currentGame || !roomStore.currentRoom) return
  
  const currentUserId = String(userStore.user.id)
  const player = gameStore.currentGame.players.find(p => p.id === currentUserId)
  if (!player) return

  const allInAmount = player.chips
  console.log('Áé©ÂÆ∂ÂÖ®‰∏ã:', allInAmount)
  websocketService.sendGameAction(Number(roomStore.currentRoom.id), 'all_in', allInAmount)
}

const showCards = () => {
  if (!userStore.user || !gameStore.currentGame || !roomStore.currentRoom) return
  
  const currentUserId = String(userStore.user.id)
  const player = gameStore.currentGame.players.find(p => p.id === currentUserId)
  if (!player || !player.cards || player.cards.length === 0) {
    alert('Ê≤°ÊúâÊâãÁâåÂèØ‰ª•Â±ïÁ§∫')
    return
  }
  
  // Á°ÆËÆ§ÊòØÂê¶Ë¶ÅÂ±ïÁ§∫ÊâãÁâå
  const confirmed = confirm('Á°ÆÂÆöË¶ÅÂêëÊâÄÊúâÁé©ÂÆ∂Â±ïÁ§∫‰Ω†ÁöÑÊâãÁâåÂêóÔºü')
  if (!confirmed) return
  
  // ÈÄöËøáWebSocketÂπøÊí≠Â±ïÁ§∫ÊâãÁâå
  websocketService.showCards(Number(roomStore.currentRoom.id))
  
  console.log('Â±ïÁ§∫ÊâãÁâå:', player.cards)
  

}



const toggleReady = async () => {
  if (!userStore.user || !roomStore.currentRoom) return
  
  try {
    const newReadyState = !isPlayerReady.value
    
    // ÈÄöËøáWebSocketÂèëÈÄÅplayer_readyÊ∂àÊÅØ
    if (websocketService.isConnected()) {
      websocketService.send({
        type: 'player_ready',
        data: {
          room_id: roomStore.currentRoom.id,
          ready: newReadyState
        }
      })
      
      // Êõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
      isPlayerReady.value = newReadyState
      console.log('Áé©ÂÆ∂ÂáÜÂ§áÁä∂ÊÄÅ:', isPlayerReady.value)
    } else {
      console.error('WebSocketÊú™ËøûÊé•ÔºåÊó†Ê≥ïËÆæÁΩÆÂáÜÂ§áÁä∂ÊÄÅ')
    }
  } catch (error) {
    console.error('ËÆæÁΩÆÂáÜÂ§áÁä∂ÊÄÅÈîôËØØ:', error)
  }
}



// Ëé∑ÂèñÊåáÂÆöÂ∫ß‰ΩçÁöÑÁé©ÂÆ∂
const getPlayerAtSeat = (seatIndex: number) => {
  if (!gameStore.currentGame) return null
  // Âè™ËøîÂõûpositionÁ≠â‰∫éseatIndex‰∏î‰∏ç‰∏∫-1ÁöÑÁé©ÂÆ∂
  const player = gameStore.currentGame.players.find(player => player.position === seatIndex && player.position >= 0) || null
  console.log(`[DEBUG] getPlayerAtSeat(${seatIndex}):`, player ? `${player.username} (id: ${player.id}, position: ${player.position})` : 'empty')
  return player
}

// Ê£ÄÊü•ÊåáÂÆöÂ∫ß‰ΩçÊòØÂê¶ÊòØÂΩìÂâçÁé©ÂÆ∂
const isCurrentPlayerAtSeat = (seatIndex: number) => {
  if (!gameStore.currentGame) return false
  const player = getPlayerAtSeat(seatIndex)
  if (!player) return false
  
  // ÈÄöËøácurrentPlayerIndexÊâæÂà∞ÂΩìÂâçÁé©ÂÆ∂
  const currentPlayer = gameStore.currentGame.players[gameStore.currentGame.currentPlayerIndex]
  if (!currentPlayer) return false
  
  const isCurrentPlayer = player.id === currentPlayer.id
  console.log(`[DEBUG] isCurrentPlayerAtSeat(${seatIndex}): player=${player.username}, currentPlayer=${currentPlayer.username}, isCurrent=${isCurrentPlayer}`)
  return isCurrentPlayer
}

// Ê£ÄÊü•ÊåáÂÆöÂ∫ß‰ΩçÊòØÂê¶ÊòØÂ∫ÑÂÆ∂
const isDealerAtSeat = (seatIndex: number) => {
  if (!gameStore.currentGame) return false
  const player = getPlayerAtSeat(seatIndex)
  if (!player) return false
  
  // ÈÄöËøádealerPositionÊâæÂà∞Â∫ÑÂÆ∂
  const dealerPlayer = gameStore.currentGame.players.find(p => p.position === gameStore.currentGame.dealerPosition)
  if (!dealerPlayer) return false
  
  const isDealer = player.id === dealerPlayer.id
  console.log(`[DEBUG] isDealerAtSeat(${seatIndex}): player=${player.username}, dealerPlayer=${dealerPlayer.username}, isDealer=${isDealer}`)
  return isDealer
}

// Â§ÑÁêÜÂ∫ß‰ΩçÁÇπÂáª
const handleSeatClick = async (seatIndex: number) => {
  console.log(`[DEBUG] handleSeatClick called with seatIndex: ${seatIndex}`)
  
  if (!userStore.user || !roomStore.currentRoom) {
    console.log('[DEBUG] User or room not available')
    return
  }
  
  const playerAtSeat = getPlayerAtSeat(seatIndex)
  const currentUserId = String(userStore.user.id)
  
  console.log(`[DEBUG] Current user ID: ${currentUserId}`)
  console.log(`[DEBUG] Player at seat ${seatIndex}:`, playerAtSeat)
  
  // Â¶ÇÊûúÂ∫ß‰Ωç‰∏∫Á©∫ÔºåÁõ¥Êé•ÂÖ•Â∫ß
  if (!playerAtSeat) {
    console.log(`[DEBUG] Â∫ß‰Ωç ${seatIndex} ‰∏∫Á©∫ÔºåÂ∞ùËØïÂÖ•Â∫ß`)
    await selectSeat(seatIndex)
    return
  }
  
  // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØËá™Â∑±ÁöÑÂ∫ß‰ΩçÔºå‰∏çÂÅö‰ªª‰ΩïÊìç‰Ωú
  if (playerAtSeat.id === currentUserId) {
    console.log('[DEBUG] ÁÇπÂáª‰∫ÜËá™Â∑±ÁöÑÂ∫ß‰ΩçÔºåÊó†ÈúÄÊìç‰Ωú')
    return
  }
  
  // Â¶ÇÊûúÂ∫ß‰ΩçË¢´ÂÖ∂‰ªñÁé©ÂÆ∂Âç†Áî®ÔºåÊèêÁ§∫Áî®Êà∑
  console.log(`[DEBUG] Â∫ß‰Ωç ${seatIndex} Â∑≤Ë¢´Áé©ÂÆ∂ ${playerAtSeat.username} Âç†Áî®`)
  alert(`Â∫ß‰Ωç ${seatIndex + 1} Â∑≤Ë¢´ ${playerAtSeat.username} Âç†Áî®`)
}

// Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÈúÄË¶ÅÈÄâÊã©Â∫ß‰ΩçÔºàÂ∑≤ÁßªÈô§Â∫ß‰ΩçÈÄâÊã©ÂäüËÉΩÔºâ
const checkUserSeat = async () => {
  if (!userStore.user || !gameStore.currentGame) return
  
  // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁªèÊúâÂ∫ß‰Ωç
  const currentUserId = String(userStore.user.id)
  const currentPlayer = gameStore.currentGame.players.find(p => p.id === currentUserId)
  
  console.log(`[DEBUG] checkUserSeat: currentPlayer=`, currentPlayer)
  
  if (currentPlayer && currentPlayer.position >= 0) {
    console.log(`Áî®Êà∑ ${currentUserId} Â∑≤ÊúâÂ∫ß‰ΩçÔºå‰ΩçÁΩÆ:`, currentPlayer.position)
    return
  }
  
  console.log(`Áî®Êà∑ ${currentUserId} ÈúÄË¶ÅÈÄâÊã©Â∫ß‰ΩçÔºå‰ΩÜÂ∫ß‰ΩçÈÄâÊã©ÂäüËÉΩÂ∑≤ÁßªÈô§`)
}

// ÈÄâÊã©Â∫ß‰Ωç
const selectSeat = async (seatIndex: number) => {
  try {
    if (!userStore.user || !roomStore.currentRoom) {
      console.error('Áî®Êà∑Êú™ÁôªÂΩïÊàñ‰∏çÂú®ÊàøÈó¥‰∏≠')
      return
    }

    console.log(`[DEBUG] Â∞ùËØïÈÄâÊã©Â∫ß‰Ωç: ${seatIndex}`)
    
    const response = await fetch(`${API_BASE_URL}/api/rooms/${roomStore.currentRoom.id}/change-seat`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${userStore.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        seat_index: seatIndex
      })
    })

    if (response.ok) {
      const result = await response.json()
      console.log('ÂàáÊç¢Â∫ß‰ΩçÊàêÂäü:', result)
      
      // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
      if (result.game_state) {
        updateGameStateFromAPI(result.game_state)
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâËøîÂõûÊ∏∏ÊàèÁä∂ÊÄÅÔºåÊâãÂä®Ëé∑Âèñ
        await fetchGameState()
      }
    } else {
      const error = await response.json()
      console.error('ÂàáÊç¢Â∫ß‰ΩçÂ§±Ë¥•:', error)
      alert(error.detail || 'ÂàáÊç¢Â∫ß‰ΩçÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï')
    }
  } catch (error) {
    console.error('ÂàáÊç¢Â∫ß‰ΩçÈîôËØØ:', error)
    alert('ÂàáÊç¢Â∫ß‰ΩçÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï')
  }
}

// Ê†πÊçÆÁé©ÂÆ∂IDËé∑ÂèñÁé©ÂÆ∂‰ø°ÊÅØ
const getPlayerById = (playerId: string) => {
  if (!gameStore.currentGame) return null
  return gameStore.currentGame.players.find(p => p.id === playerId)
}

// ÂºÄÂßãÊñ∞Ê∏∏Êàè
const startNewGame = async () => {
  try {
    if (!roomStore.currentRoom) return
    
    // Âè™ÂÖ≥Èó≠ÂΩìÂâçÁî®Êà∑ÁöÑÊ∏∏ÊàèÁªìÊùüÂºπÁ™óÔºå‰∏çÊ∏ÖÈô§Ê∏∏ÊàèÁªìÊûúÊï∞ÊçÆ
    showGameResultModal.value = false
    
    // Ëá™Âä®ËÆæÁΩÆÂΩìÂâçÁé©ÂÆ∂‰∏∫ÂáÜÂ§áÁä∂ÊÄÅ
    if (!isPlayerReady.value) {
      await toggleReady()
    }
    
    // Ê≥®ÊÑèÔºö‰∏çË∞ÉÁî®ÂêéÁ´ØÁöÑstart-gameÊé•Âè£ÔºåÂõ†‰∏∫ÈÇ£‰ºöÂΩ±ÂìçÊâÄÊúâÁé©ÂÆ∂
    // Âè™ÊòØËÆ©ÂΩìÂâçÁé©ÂÆ∂ÂáÜÂ§áÔºåÁ≠âÊâÄÊúâÁé©ÂÆ∂ÈÉΩÂáÜÂ§áÂêéÊ∏∏Êàè‰ºöËá™Âä®ÂºÄÂßã
    
    console.log('ÂΩìÂâçÁé©ÂÆ∂Â∑≤ÂáÜÂ§áÔºåÁ≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂ÂáÜÂ§á')
  } catch (error) {
    console.error('ÂáÜÂ§áÊ∏∏ÊàèÈîôËØØ:', error)
    alert('ÂáÜÂ§áÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï')
  }
}

const leaveGame = async () => {
  try {
    console.log('[DEBUG] Leaving game...')
    const result = await roomStore.leaveRoom()
    console.log('[DEBUG] Leave room result:', result)
    
    gameStore.leaveGame()
    console.log('[DEBUG] Game store cleared')
    
    console.log('[DEBUG] Navigating to lobby...')
    // ‰ΩøÁî®replaceËÄå‰∏çÊòØpushÔºåÈÅøÂÖçÁî®Êà∑ËøîÂõûÂà∞Ê∏∏ÊàèÈ°µÈù¢
    await router.replace('/lobby')
    console.log('[DEBUG] Navigation completed')
  } catch (error) {
    console.error('[DEBUG] Error leaving game:', error)
    // Ê∏ÖÈô§Êú¨Âú∞Áä∂ÊÄÅ
    gameStore.leaveGame()
    roomStore.currentRoom = null
    // Âº∫Âà∂Ë∑≥ËΩ¨Âà∞Â§ßÂéÖ
    console.log('[DEBUG] Force navigation to lobby')
    window.location.href = '/lobby'
  }
}

// ÁîüÂëΩÂë®Êúü
onMounted(async () => {
  // ÂàùÂßãÂåñÊ∏∏ÊàèÁä∂ÊÄÅ
  await initializeGame()
  
  // ËÆæÁΩÆÂÆöÊó∂Âô®ÂÆöÊúüËé∑ÂèñÊ∏∏ÊàèÁä∂ÊÄÅ
  const gameStateInterval = setInterval(async () => {
    await fetchGameState()
  }, 2000) // ÊØè2ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°Ê∏∏ÊàèÁä∂ÊÄÅ
  
  // ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®
  onUnmounted(() => {
    clearInterval(gameStateInterval)
  })
})

// ÂàùÂßãÂåñÊ∏∏Êàè
const initializeGame = async () => {
  try {
    // Á°Æ‰øùÁî®Êà∑Â∑≤ÁôªÂΩï‰∏îÂú®ÊàøÈó¥‰∏≠
    if (!userStore.user || !roomStore.currentRoom) {
      console.error('Áî®Êà∑Êú™ÁôªÂΩïÊàñ‰∏çÂú®ÊàøÈó¥‰∏≠')
      router.push('/lobby')
      return
    }
    
    // Ê∏ÖÈô§‰πãÂâçÁöÑÊ∏∏ÊàèÁªìÊûúÂíåÂºπÁ™óÁä∂ÊÄÅ
    showGameResultModal.value = false
    gameStore.clearGameResults()
    
    // ÂÖàÂä†ÂÖ•Ê∏∏Êàè
    await joinGameAPI()
    
    // ÁÑ∂ÂêéËé∑ÂèñÊ∏∏ÊàèÁä∂ÊÄÅ
    await fetchGameState()
    
    // Ê£ÄÊü•Áî®Êà∑Â∫ß‰ΩçÁä∂ÊÄÅ
    setTimeout(async () => {
      await checkUserSeat()
    }, 1000) // Âª∂Ëøü1ÁßíÁ°Æ‰øùÊ∏∏ÊàèÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞
    
    console.log('Ê∏∏ÊàèÂàùÂßãÂåñÂÆåÊàê')
  } catch (error) {
    console.error('Ê∏∏ÊàèÂàùÂßãÂåñÂ§±Ë¥•:', error)
  }
}

// Âä†ÂÖ•Ê∏∏ÊàèAPI
const joinGameAPI = async () => {
  try {
    if (!roomStore.currentRoom) return
    
    const response = await fetch(`${API_BASE_URL}/api/rooms/${roomStore.currentRoom.id}/join-game`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${userStore.token}`,
        'Content-Type': 'application/json'
      }
    })
    
    if (response.ok) {
      const result = await response.json()
      console.log('Âä†ÂÖ•Ê∏∏ÊàèÊàêÂäü:', result.message)
      
      // Â¶ÇÊûúËøîÂõû‰∫ÜÊ∏∏ÊàèÁä∂ÊÄÅÔºåÁõ¥Êé•Êõ¥Êñ∞
      if (result.game_state) {
        updateGameStateFromAPI(result.game_state)
      }
    } else {
      console.error('Âä†ÂÖ•Ê∏∏ÊàèÂ§±Ë¥•:', response.statusText)
    }
  } catch (error) {
    console.error('Âä†ÂÖ•Ê∏∏ÊàèÈîôËØØ:', error)
  }
}

// Ëé∑ÂèñÊ∏∏ÊàèÁä∂ÊÄÅ
const fetchGameState = async () => {
  try {
    if (!roomStore.currentRoom) return
    
    const response = await fetch(`${API_BASE_URL}/api/rooms/${roomStore.currentRoom.id}/game-state`, {
      headers: {
        'Authorization': `Bearer ${userStore.token}`,
        'Content-Type': 'application/json'
      }
    })
    
    if (response.ok) {
      const gameData = await response.json()
      
      // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
      if (gameData.game) {
        updateGameStateFromAPI(gameData)
        // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅÂêéÊ£ÄÊü•Áî®Êà∑Â∫ß‰Ωç
        await checkUserSeat()
      }
      
      console.log('Ê∏∏ÊàèÁä∂ÊÄÅÊõ¥Êñ∞:', gameData)
    } else {
      console.error('Ëé∑ÂèñÊ∏∏ÊàèÁä∂ÊÄÅÂ§±Ë¥•:', response.statusText)
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÊ∏∏ÊàèÁä∂ÊÄÅÈîôËØØ:', error)
  }
}

// ‰ªéAPIÊï∞ÊçÆÊõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
const updateGameStateFromAPI = (apiData: any) => {
  try {
    // Êõ¥Êñ∞ÊàøÈó¥‰ø°ÊÅØ
    if (apiData.room) {
      roomStore.currentRoom = apiData.room
    }
    
    // ‰ΩøÁî®gameStoreÁöÑÊñπÊ≥ïÊù•Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅÔºåÁ°Æ‰øù‰∏éWebSocketÂ§ÑÁêÜ‰∏ÄËá¥
    gameStore.updateGameStateFromAPI(apiData)
    
    // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑ÁöÑÂáÜÂ§áÁä∂ÊÄÅ
    if (userStore.user && gameStore.currentGame) {
      const currentUserId = String(userStore.user.id)
      const currentPlayer = gameStore.currentGame.players.find(p => p.id === currentUserId)
      if (currentPlayer) {
        isPlayerReady.value = currentPlayer.isReady
        console.log(`Áé©ÂÆ∂ ${currentUserId} ÂáÜÂ§áÁä∂ÊÄÅÊõ¥Êñ∞‰∏∫:`, isPlayerReady.value)
      } else {
        isPlayerReady.value = false
        console.log(`Áé©ÂÆ∂ ${currentUserId} ‰∏çÂú®Ê∏∏Êàè‰∏≠ÔºåÈáçÁΩÆÂáÜÂ§áÁä∂ÊÄÅ`)
      }
    }
    
    console.log('Ê∏∏ÊàèÁä∂ÊÄÅÂ∑≤ÈÄöËøáGamePageÊõ¥Êñ∞')
  } catch (error) {
    console.error('Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅÂ§±Ë¥•:', error)
  }
}

onMounted(async () => {
  // Âª∫Á´ãWebSocketËøûÊé•
  await connectWebSocket()
  
  // Â¶ÇÊûúÂ∑≤ËøûÊé•ÔºåÂä†ÂÖ•ÊàøÈó¥
  if (roomStore.currentRoom && websocketService.isConnected()) {
    websocketService.joinRoom(Number(roomStore.currentRoom.id))
  }
  
  // ÂàùÂßãÂåñÊ∏∏Êàè
  await initializeGame()
})

onUnmounted(() => {
  // Á¶ªÂºÄÊàøÈó¥
  if (roomStore.currentRoom && websocketService.isConnected()) {
    websocketService.leaveRoom(Number(roomStore.currentRoom.id))
  }
  
  // Êñ≠ÂºÄWebSocketËøûÊé•
  disconnectWebSocket()
  
  // Ê∏ÖÁêÜËµÑÊ∫ê
})
</script>